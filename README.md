# Awesome-mailer (updated Unisender mailer)

Задача проекта - это создание/поддержание рассылки писем и приём вебхуков с изменением статусов клиентов и почтовиков.  
Старый проект давно перешёл в состояние legacy, его обновление **уже невозможно** в связи со сложностью написания предыдущим специалистом.  
Было принято решение - составить ТЗ и написать более оптимизированную версию реализацию мейлера.
Которую легко будет поддерживать в будущем.

## Глоссарий

-   **Лид** - клиент одной из црм, с телефоном, email, статусом и тд.
-   **Unisender** - сервис отправки писем. Вся отправка будет происходить через этот сервис.
-   **Gate/гейт** - система распределения лидов, а также синхронизации статусов с ЦРМ. Послужит отправителем веб-хуков на мейлер
-   **DBAdmin (DBA)** - веб-панель под гейт.
-   **Source_id (сорс)** - идентификатор креатива (TEST01RU), имеет язык и может быть иметь несколько номеров
-   **Domain (домен)** - в данном контексте - это домен с которого пришёл лид.
-   **Sender (сендер)** - почта, подтверждённая и добавленная в `unisender`, используется для отправки писем. Используется сорсом. _НЕобязательно_ что сендер будет соответствовать домену лида.
-   **Трек критерий** - `source_id` + `status` лида. Вся рассылка будет базироваться на этих параметрах. Это данные получаемые вебхуком от гейта
-   **Pattern (паттерн/шаблон)** - шаблон письма конкретного трека. Все паттерны внутри сорса схожи, но могут нести разный смысл в завимимости от статуса лида. Также имеют внутри макросы для подмены полями лида.

_Пример шаблона_:

```
Здравствуйте %first_name% %last_name%! %date% Вы попали на платформу.
Проверьте актуальность вашего номера телефона: %phone%
Перейдите по ссылке, если номер был изменён:
https://%domain%/recheck-phone/%client_id%?password=%password%
```

-   **Pattern status chain (цепочка статуса)** - последовательность писем под конкретный статус, каждое следующее письмо имеет определённую задержку перед отправкой. Если статус лида изменился - письмо не будет отправлено из прошлой цепочки.
-   **Source pattern (шаблон сорса)** - набор из Status chain под конкретный креатив.
    Чаще всего состоящий из стандартных статусов _New/No answer/Not interested/Deposit_.
    Лид будет сопровождаться всегда одним шаблоном сорса и получать письма по мере изменения его статуса.

-   **Мыло/Мыльник/Email** - электронный адрес почты лида.
-   **CRUD - create/read/update/delete)** - сокращение названия набора операций по чтению/созданию/обновлению/удалению с конкретной сущностью
-   **Админка/веб-панель** - сайт с веб-панелью, в которой будут происходить абсолютно все операции указанные в этом документе.

## Основные задачи проекта

1.  CRUD всех типов шаблонов (также цепочек)
2.  Добавление _сендера_ прямо из админка
3.  Тестирование отправки шаблона, с возможностью указать поля лида (или сгенерировать) и отправить на конкретный мыльник
4.  Отслеживание состояния жизнеспособности сендера
5.  Просмотр статистики по кол-ву отправок/отписок от рассылки/ошибкам
6.  Просмотр логов по вебхукам от **gate** и **unisender**
7.  Создание особых эндпоинтов для ссылок в письмах (например сброс пароля)

## Технологии

Будем использовать обычный наш осовремененный стак под SOLID:

-   _NodeJS/NestJS/TypeScript_ база
-   _PM2_ в качестве демона NodeJS
-   _MySQL/Redis/TypeORM_ под хранение кэша и данных через ORM
-   _NGINX_ как веб-сервер проксирующий на NodeJS
-   _Socket.IO_ под ивенты (о нём в отдельном разделе)
-   _Swagger_ под front-end документацию

> Кэшируемые данные будут помечаться знаками  
> `rin` (redis in) - на запись  
> `rout` (redis out) - на чтение  
> `rstart` (redis start) - данные которые нужно  очистить и добавить кэш на пере/запуске  
> также читать из кэша и изменять его при операциях с этими данныи

## Сущности/База данных

Описание всех объектов которые будут использоваться в проекте.  
_Примечание_: они быть изменены на этапе проектирования.  
Однозначно все записи будут иметь стандартные поля такие как: _id createdAt updatedAt isDeleted_

---

**ВАЖНО**: мы не выполняем никаких _DELETE_ операций к базе данных.  
Все удалённые записи помечаются как `"isDeleted: 1"` и будут недоступны для любых операций.  
Если таблица учитывает уникальность поля и просто пометить как **удалено** нельзя.

> Тогда в сущности не создается поле **isDeleted** и вместо создания записи с конфликтом - мы обновляем старую которую могли бы удалить.

---

**ТАКЖЕ**: все операции по изменения структуры БД - выполняются **_исключительно_ через миграции TypeORM !!!**  
Это же и касается сидов под таблицы со статическими данными, например языки/гео и тд

---

## Перечень сущностей

_Lead_ - карточка лида. Имя, фамилия, телефон, мыло, домен, сорс. оффер. афилят.

---

_Source_ - креатив, имеет название, язык и номер (TEST01RU)

---

_Sender_ - привязан к _Source_ имеет домен (example.com) и отправителя (info) -> info@example.com  
Имеет `status` жизни:

0. created (ожидает подтверждения на почте)
1. active (рабочий)
2. inactive (отключён, по каким-то причинам)
3. banned (перманентный статус, выдаётся вебхуком **unisender** о этом позже)

---

_LeadStatus_ - список статусов лидов. Используется для выставлении в шаблонах. `rstart`

> На запуске проекта - таблица будет "набита" сидом. Но по мере поступления вебхуков - нужно будет добавлять статус в базу (также `rin`) если такого не существует

---

_LeadMail_ - запись "заготовки" письма для лида. Привязана к _Pattern_ и _Lead_

> Дата отправки определяется "_задержкой_" паттерна. Например:  
> Сейчас 10:00 01.12.2021. У паттерна задержка 60 (в минутах)  
> Дата которая будет записана 11:00 01.12.2021

> Запись создаётся на вебхуке от гейта, если нашлось совпадение под письмо и такого письма ещё не было доставлено.

Имеет `status` отправки

0. created (новая запись, ждёт отправки по таймеру) `rstart`
1. sent (отправлено)
2. error (ошибка отправки)
3. cancel (отмена, например если статус сменился)

---

_Pattern_ - шаблон письма. Привязан к _LeadStatus_ и _Source_ (опционально). Язык берётся из _Source_.  
Имеет короткое название в БД (для внутреннего использования) также имеет задержу(в минутах) и индекс который по дефолту всегда 0  
По индексу определяется каким по счёту это письмо будет отправлено,  
через выгрузку из _LeadMail_ по ID _Lead_ и _LeadStatus_

> Внутренность письма хранится файлом в папке `patterns`. Название файла соответствует ID в базе.

> _Source_ уникален, но разрешён **NULL**, это нужно для дефолтных паттернов под _LeadStatus_

> При создании обязательно проверять на конфликт с индексом/статусом/сорсом.  
> На уровне ключей БД - это нереализуемо, но можно кодом

---

_PatternSource_ - **АБСТРАКТНЫЙ**. Не записан в БД.  
Является презентацией набора из _Pattern_ конкретного _Source_

> Также есть дефолтный _PatternSource_ который выгружает все паттерны где `Source IS NULL`

---

_PatternStatusChain_ - **АБСТРАКТНЫЙ**. Не записан в БД.  
Является презентацией всех паттерном в _LeadStatus_ и _Source_

> Также есть дефолтный _PatternStatusChain_ который выгружает все паттерны по статусу где `Source IS NULL`